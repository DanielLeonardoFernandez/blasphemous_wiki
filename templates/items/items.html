{% extends "base.html" %}

{% block content %}
<h1>Items de la Wiki de Blasphemous</h1>

<!-- Botones principales -->
<div class="mb-4">
    <button class="btn btn-success" onclick="mostrarFormCrear()">Crear nuevo item</button>
    <a href="/items/estado/eliminados" class="btn btn-secondary">Ver eliminados</a>
</div>

<!-- BARRA DE BÚSQUEDA -->
{% include 'items/items_search.html' %}

<!-- FORMULARIO CREAR -->
<div id="form-crear" class="card p-3 mb-4" style="display:none; max-width: 600px;">
    <h4>Crear nuevo item</h4>
    <form id="crear-form" enctype="multipart/form-data">
        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea name="descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo</label>
            <input type="number" name="costo" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Indispensable</label>
            <input type="checkbox" name="indispensable">
        </div>

        <div class="mb-3">
            <label class="form-label">Categorías (IDs separados por coma)</label>
            <input type="text" name="categoria_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen</label>
            <input type="file" name="imagen" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Ubicaciones (IDs separados por coma)</label>
            <input type="text" name="ubicacion_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Interacciones (IDs separados por coma)</label>
            <input type="text" name="interaccion_ids" class="form-control">
        </div>

        <button class="btn btn-success" type="submit">Crear</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormCrear()">Cancelar</button>
    </form>
</div>

<!-- FORMULARIO EDITAR -->
<div id="form-editar" class="card p-3 mb-4" style="display:none; max-width:600px;">
    <h4>Editar item</h4>
    <form id="editar-form" enctype="multipart/form-data">
        <input type="hidden" name="item_id" id="item_id">

        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" id="editar-nombre" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea name="descripcion" id="editar-descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo</label>
            <input type="number" name="costo" id="editar-costo" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Indispensable</label>
            <input type="checkbox" name="indispensable" id="editar-indispensable">
        </div>

        <div class="mb-3">
            <label class="form-label">Categorías (IDs separados por coma)</label>
            <input type="text" name="categoria_ids" id="editar-categoria_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen nueva (opcional)</label>
            <input type="file" name="imagen" id="editar-imagen" class="form-control">
            <p class="text-muted">Si no subes nada, la imagen se mantiene.</p>
        </div>

        <div class="mb-3">
            <label class="form-label">Ubicaciones (IDs separados por coma)</label>
            <input type="text" name="ubicacion_ids" id="editar-ubicacion_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Interacciones (IDs separados por coma)</label>
            <input type="text" name="interaccion_ids" id="editar-interaccion_ids" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Guardar cambios</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormEditar()">Cancelar</button>
    </form>
</div>

{% if items %}
<div class="row">
    {% for item in items %}
        <div class="col-md-4 mb-4">

            <!-- Toda la card como enlace -->
            <a href="/items/{{ item.id }}/detalles" style="text-decoration: none; color: inherit;">
                <div class="card">
                    {% if item.imagen_url %}
                        <img src="{{ item.imagen_url }}" class="card-img-top" alt="{{ item.nombre }}">
                    {% else %}
                        <img src="https://via.placeholder.com/300x200?text=Sin+imagen" class="card-img-top" alt="Sin imagen">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ item.nombre }}</h5>
                        <p><strong>Costo:</strong> {{ item.costo or "sin precio" }}</p>
                        <p><strong>Indispensable:</strong> {{ "Sí" if item.indispensable else "No" }}</p>
                    </div>
                </div>
            </a>

            <!-- Botones fuera del <a> usando data-json -->
            <div class="mt-2 d-flex justify-content-between">
                <button class="btn btn-primary btn-sm btn-editar"
                    data-json='{{ item|tojson|safe }}'>
                    Editar
                </button>

                <button class="btn btn-danger btn-sm" onclick="eliminarItem({{ item.id }})">
                    Eliminar
                </button>
            </div>

        </div>
    {% endfor %}
</div>
{% else %}
<p>No hay items activos.</p>
{% endif %}

{% endblock %}

{% block scripts %}

<script>
// Mostrar / ocultar formulario crear
function mostrarFormCrear() {
    document.getElementById("form-crear").style.display = "block";
}
function ocultarFormCrear() {
    document.getElementById("form-crear").style.display = "none";
}

// Mostrar / ocultar formulario editar
function mostrarFormEditar() {
    document.getElementById("form-editar").style.display = "block";
}
function ocultarFormEditar() {
    document.getElementById("form-editar").style.display = "none";
    document.getElementById("editar-form").reset();
}

// Asignar datos de cada botón de editar usando JSON
document.querySelectorAll(".btn-editar").forEach(btn => {
    btn.addEventListener("click", () => {
        const item = JSON.parse(btn.dataset.json);
        mostrarFormEditar();
        document.getElementById("item_id").value = item.id;
        document.getElementById("editar-nombre").value = item.nombre;
        document.getElementById("editar-descripcion").value = item.descripcion;
        document.getElementById("editar-costo").value = item.costo || '';
        document.getElementById("editar-indispensable").checked = item.indispensable;

        document.getElementById("editar-categoria_ids").value = item.categorias.map(c => c.id).join(',');
        document.getElementById("editar-ubicacion_ids").value = item.ubicaciones.map(u => u.id).join(',');
        document.getElementById("editar-interaccion_ids").value = item.interacciones.map(i => i.id).join(',');
    });
});

//-----------------------------------------
// CREAR ITEM
//-----------------------------------------
document.getElementById("crear-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const raw = new FormData(form);

    function addList(fieldName) {
        const value = raw.get(fieldName)?.trim() || "";
        raw.delete(fieldName);
        if (value !== "") {
            value.split(",").map(x => x.trim()).filter(x => x !== "").forEach(v => raw.append(fieldName, Number(v)));
        }
    }

    addList("categoria_ids");
    addList("ubicacion_ids");
    addList("interaccion_ids");

    try {
        const response = await fetch("/items/", { method: "POST", body: raw });
        if (response.ok) {
            alert("Item creado exitosamente.");
            form.reset();
            ocultarFormCrear();
            location.reload();
        } else {
            const error = await response.json();
            alert("Error al crear el item: " + JSON.stringify(error.detail));
        }
    } catch (err) {
        alert("Error de conexión o inesperado: " + err);
    }
});

//-----------------------------------------
// EDITAR ITEM
//-----------------------------------------
document.getElementById("editar-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const raw = new FormData(e.target);
    const itemId = raw.get("item_id");
    raw.delete("item_id");

    function addList(fieldName) {
        const value = raw.get(fieldName)?.trim() || "";
        raw.delete(fieldName);
        if (value !== "") {
            value.split(",").map(x => x.trim()).forEach(v => raw.append(fieldName, v));
        }
    }

    addList("categoria_ids");
    addList("ubicacion_ids");
    addList("interaccion_ids");

    const response = await fetch(`/items/${itemId}`, { method: "PUT", body: raw });
    if (response.ok) {
        alert("Ítem actualizado.");
        ocultarFormEditar();
        location.reload();
    } else {
        const error = await response.json();
        alert("Error al editar: " + JSON.stringify(error.detail));
    }
});

//-----------------------------------------
// ELIMINAR ITEM
//-----------------------------------------
async function eliminarItem(id) {
    const confirmar = confirm("¿Seguro que deseas eliminar este ítem?");
    if (!confirmar) return;

    const response = await fetch(`/items/${id}`, { method: "DELETE" });
    if (response.ok) {
        alert("Ítem eliminado exitosamente.");
        location.reload();
    } else {
        const error = await response.json();
        alert("Error al eliminar el ítem: " + (error.detail || "Desconocido"));
    }
}
</script>

{% endblock %}
