{% extends "base.html" %}

{% block content %}
<h1>Items de la Wiki de Blasphemous</h1>

<!-- Botones principales -->
<div class="mb-4">
    <button class="btn btn-success" onclick="mostrarFormCrear()">Crear nuevo item</button>
    <a href="/items/estado/eliminados" class="btn btn-secondary">Ver eliminados</a>
</div>

<!-- BARRA DE B칔SQUEDA -->
{% include 'items/items_search.html' %}

<!-- FORMULARIO CREAR -->
<div id="form-crear" class="card p-3 mb-4" style="display:none; max-width: 600px;">
    <h4>Crear nuevo item</h4>
    <form id="crear-form" enctype="multipart/form-data">
        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripci칩n</label>
            <textarea name="descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo</label>
            <input type="number" name="costo" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Indispensable</label>
            <input type="checkbox" name="indispensable">
        </div>

        <div class="mb-3">
            <label class="form-label">Categor칤as (IDs separados por coma)</label>
            <input type="text" name="categoria_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen</label>
            <input type="file" name="imagen" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Ubicaciones (IDs separados por coma)</label>
            <input type="text" name="ubicacion_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Interacciones (IDs separados por coma)</label>
            <input type="text" name="interaccion_ids" class="form-control">
        </div>

        <button class="btn btn-success" type="submit">Crear</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormCrear()">Cancelar</button>
    </form>
</div>

<!-- FORMULARIO EDITAR -->
<div id="form-editar" class="card p-3 mb-4" style="display:none; max-width:600px;">
    <h4>Editar item</h4>
    <form id="editar-form" enctype="multipart/form-data">
        <input type="hidden" name="item_id" id="item_id">

        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" id="editar-nombre" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripci칩n</label>
            <textarea name="descripcion" id="editar-descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo</label>
            <input type="number" name="costo" id="editar-costo" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Indispensable</label>
            <input type="checkbox" name="indispensable" id="editar-indispensable">
        </div>

        <div class="mb-3">
            <label class="form-label">Categor칤as (IDs separados por coma)</label>
            <input type="text" name="categoria_ids" id="editar-categoria_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen nueva (opcional)</label>
            <input type="file" name="imagen" id="editar-imagen" class="form-control">
            <p class="text-muted">Si no subes nada, la imagen se mantiene.</p>
        </div>

        <div class="mb-3">
            <label class="form-label">Ubicaciones (IDs separados por coma)</label>
            <input type="text" name="ubicacion_ids" id="editar-ubicacion_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Interacciones (IDs separados por coma)</label>
            <input type="text" name="interaccion_ids" id="editar-interaccion_ids" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Guardar cambios</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormEditar()">Cancelar</button>
    </form>
</div>

{% if items %}
<div class="row">
    {% for item in items %}
        <div class="col-md-4 mb-4">

            <!-- Toda la card ahora es un enlace -->
            <a href="/items/{{ item.id }}/detalles" style="text-decoration: none; color: inherit;">
                <div class="card">

                    {% if item.imagen_url %}
                        <img src="{{ item.imagen_url }}" class="card-img-top" alt="{{ item.nombre }}">
                    {% else %}
                        <img src="https://via.placeholder.com/300x200?text=Sin+imagen" class="card-img-top" alt="Sin imagen">
                    {% endif %}

                    <div class="card-body">
                        <h5 class="card-title">{{ item.nombre }}</h5>
                        <p class="card-text">{{ item.descripcion }}</p>

                        <p><strong>Costo:</strong> {{ item.costo or "No especificado" }}</p>
                        <p><strong>Indispensable:</strong> {{ "S칤" if item.indispensable else "No" }}</p>

                        <p><strong>Categor칤as:</strong>
                            {% if item.categoria_ids %}
                                {% for cid in item.categoria_ids %}
                                    {{ cid }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                Ninguna
                            {% endif %}
                        </p>

                        <p><strong>Ubicaciones:</strong>
                            {% if item.ubicacion_ids %}
                                {% for uid in item.ubicacion_ids %}
                                    {{ uid }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                Ninguna
                            {% endif %}
                        </p>

                        <p><strong>Interacciones:</strong>
                            {% if item.interaccion_ids %}
                                {% for iid in item.interaccion_ids %}
                                    {{ iid }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                Ninguna
                            {% endif %}
                        </p>

                        <p><strong>ID:</strong> {{ item.id }}</p>
                    </div>

                </div>
            </a>

            <!-- Botones fuera del <a> -->
            <div class="mt-2 d-flex justify-content-between">
                <button class="btn btn-primary btn-sm"
                    onclick='mostrarFormEditar(
                        {{ item.id }},
                        "{{ item.nombre|escape }}",
                        "{{ item.descripcion|escape }}",
                        "{{ item.costo or "" }}",
                        {{ "true" if item.indispensable else "false" }},
                        "{{ item.categorias|map(attribute="id")|join(",") }}",
                        "{{ item.ubicaciones|map(attribute="id")|join(",") }}",
                        "{{ item.interacciones|map(attribute="id")|join(",") }}"
                    )'>
                    Editar
                </button>

                <button class="btn btn-danger btn-sm" onclick="eliminarItem({{ item.id }})">
                    Eliminar
                </button>
            </div>

        </div>
    {% endfor %}
</div>
{% else %}
<p>No hay items activos.</p>
{% endif %}

{% endblock %}

{% block scripts %}

<script>
// Mostrar / ocultar formulario crear
function mostrarFormCrear() {
    document.getElementById("form-crear").style.display = "block";
}
function ocultarFormCrear() {
    document.getElementById("form-crear").style.display = "none";
}

// Mostrar / ocultar formulario editar
function mostrarFormEditar(id, nombre, descripcion, costo, indispensable, categorias, ubicaciones, interacciones) {
    document.getElementById("form-editar").style.display = "block";
    document.getElementById("item_id").value = id;
    document.getElementById("editar-nombre").value = nombre;
    document.getElementById("editar-descripcion").value = descripcion;
    document.getElementById("editar-costo").value = costo;
    document.getElementById("editar-indispensable").checked = indispensable === true || indispensable === "true";

    document.getElementById("editar-categoria_ids").value = categorias;
    document.getElementById("editar-ubicacion_ids").value = ubicaciones;
    document.getElementById("editar-interaccion_ids").value = interacciones;
}

function ocultarFormEditar() {
    document.getElementById("form-editar").style.display = "none";
    document.getElementById("editar-form").reset();
}

//-----------------------------------------
// 游릭 CREAR ITEM (listas correctamente enviadas como n칰meros)
//-----------------------------------------
document.getElementById("crear-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const raw = new FormData(form);

    // Funci칩n para procesar listas de IDs
    function addList(fieldName) {
        const value = raw.get(fieldName)?.trim() || "";
        raw.delete(fieldName);

        if (value !== "") {
            value
                .split(",")                // separar por comas
                .map(x => x.trim())        // eliminar espacios
                .filter(x => x !== "")     // ignorar entradas vac칤as
                .forEach(v => raw.append(fieldName, Number(v))); // enviar como n칰mero
        }
    }

    addList("categoria_ids");
    addList("ubicacion_ids");
    addList("interaccion_ids");

    try {
        const response = await fetch("/items/", {
            method: "POST",
            body: raw
        });

        if (response.ok) {
            alert("Item creado exitosamente.");
            form.reset();
            ocultarFormCrear();
            location.reload();
        } else {
            const error = await response.json();
            alert("Error al crear el item: " + JSON.stringify(error.detail));
        }
    } catch (err) {
        alert("Error de conexi칩n o inesperado: " + err);
    }
});

//
// -----------------------------------------
// 游릱 EDITAR ITEM (tambi칠n listas correctas)
// -----------------------------------------
document.getElementById("editar-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const raw = new FormData(e.target);
    const itemId = raw.get("item_id");
    raw.delete("item_id");

    function addList(fieldName) {
        const value = raw.get(fieldName)?.trim() || "";
        raw.delete(fieldName);
        if (value !== "") {
            value.split(",").map(x => x.trim()).forEach(v => raw.append(fieldName, v));
        }
    }

    addList("categoria_ids");
    addList("ubicacion_ids");
    addList("interaccion_ids");

    const response = await fetch(`/items/${itemId}`, {
        method: "PUT",
        body: raw
    });

    if (response.ok) {
        alert("칈tem actualizado.");
        ocultarFormEditar();
        location.reload();
    } else {
        const error = await response.json();
        alert("Error al editar: " + JSON.stringify(error.detail));
    }
});


// Eliminar item
async function eliminarItem(id) {
    const confirmar = confirm("쯉eguro que deseas eliminar este 칤tem?");
    if (!confirmar) return;

    const response = await fetch(`/items/${id}`, { method: "DELETE" });

    if (response.ok) {
        alert("칈tem eliminado exitosamente.");
        location.reload();
    } else {
        const error = await response.json();
        alert("Error al eliminar el 칤tem: " + (error.detail || "Desconocido"));
    }
}
</script>

{% endblock %}
