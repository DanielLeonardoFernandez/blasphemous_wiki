{% extends "base.html" %}

{% block content %}
<h1>Detalles del Item</h1>

<a href="/items" class="btn btn-secondary mb-3">Volver a la lista</a>

<!-- Contenedor ancho completo -->
<div class="item-detalle-container">

    <!-- Imagen principal -->
    {% if item.imagen_url %}
        <img src="{{ item.imagen_url }}" alt="{{ item.nombre }}" class="item-img" style="width:100%; max-height:400px; object-fit:cover; border-radius:8px; margin-bottom:20px;">
    {% else %}
        <img src="https://via.placeholder.com/1200x400?text=Sin+imagen"
             alt="Sin imagen"
             style="width:100%; max-height:400px; object-fit:cover; border-radius:8px; margin-bottom:20px;">
    {% endif %}

    <h2>{{ item.nombre }}</h2>
    <p>{{ item.descripcion or "Sin descripción" }}</p>

    <p><strong>Costo:</strong> {{ item.costo or "No especificado" }}</p>
    <p><strong>Indispensable:</strong> {{ "Sí" if item.indispensable else "No" }}</p>

    <hr>

    <!-- Categorías -->
    <h3>Categorías</h3>
    {% if item.categorias %}
        {% for c in item.categorias %}
            <div style="margin-bottom:10px;">
                <strong>{{ c.nombre }}</strong><br>
                {{ c.descripcion }}<br>
                <img src="{{ c.imagen_url }}" style="width:150px;height:150px; border-radius:10px;">
            </div>
        {% endfor %}
    {% else %}
        <p>No hay categorías</p>
    {% endif %}

    <hr>

    <!-- Ubicaciones -->
    <h3>Ubicaciones</h3>
    {% if item.ubicaciones %}
        {% for u in item.ubicaciones %}
            <div style="margin-bottom:10px;">
                <strong>{{ u.nombre }}</strong><br>
                {{ u.descripcion }}<br>
                <img src="{{ u.imagen_url }}" style="width:150px;height:150px; border-radius:5px;">
            </div>
        {% endfor %}
    {% else %}
        <p>No hay ubicaciones</p>
    {% endif %}

    <hr>

    <!-- Interacciones -->
    <h3>Interacciones</h3>
    {% if item.interacciones %}
        {% for i in item.interacciones %}
            <div style="margin-bottom:10px;">
                <strong>{{ i.descripcion }}</strong><br>
                <img src="{{ i.imagen_url }}" style="width:150px;height:150px; border-radius:5px;">
            </div>
        {% endfor %}
    {% else %}
        <p>No hay interacciones</p>
    {% endif %}

    <hr>

    <p><strong>ID:</strong> {{ item.id }}</p>

    <!-- Controles -->
    <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-primary btn-editar"
            data-json='{{ item|tojson|safe }}'>
            Editar
        </button>

        <button class="btn btn-danger" onclick="eliminarItem({{ item.id }})">
            Eliminar
        </button>
    </div>

</div>

<!-- FORMULARIO EDITAR (oculto inicialmente) -->
<div id="form-editar" class="card p-3 mb-4" style="display:none; max-width:600px; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999; max-height:80vh; overflow-y:auto;">
    <h4>Editar Item</h4>
    <form id="editar-form" enctype="multipart/form-data">
        <input type="hidden" name="item_id" id="item_id">

        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" id="editar-nombre" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea name="descripcion" id="editar-descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo</label>
            <input type="number" name="costo" id="editar-costo" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Indispensable</label>
            <input type="checkbox" name="indispensable" id="editar-indispensable">
        </div>

        <div class="mb-3">
            <label class="form-label">Categorías (IDs separados por coma)</label>
            <input type="text" name="categoria_ids" id="editar-categoria_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen nueva (opcional)</label>
            <input type="file" name="imagen" id="editar-imagen" class="form-control">
            <p class="text-muted">Si no subes nada, la imagen se mantiene.</p>
        </div>

        <div class="mb-3">
            <label class="form-label">Ubicaciones (IDs separados por coma)</label>
            <input type="text" name="ubicacion_ids" id="editar-ubicacion_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Interacciones (IDs separados por coma)</label>
            <input type="text" name="interaccion_ids" id="editar-interaccion_ids" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Guardar cambios</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormEditar()">Cancelar</button>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
function mostrarFormEditar() {
    document.getElementById("form-editar").style.display = "block";
}
function ocultarFormEditar() {
    document.getElementById("form-editar").style.display = "none";
    document.getElementById("editar-form").reset();
}

// Asignar datos desde data-json
document.querySelectorAll(".btn-editar").forEach(btn => {
    btn.addEventListener("click", () => {
        const item = JSON.parse(btn.dataset.json);
        mostrarFormEditar();
        document.getElementById("item_id").value = item.id;
        document.getElementById("editar-nombre").value = item.nombre;
        document.getElementById("editar-descripcion").value = item.descripcion;
        document.getElementById("editar-costo").value = item.costo || '';
        document.getElementById("editar-indispensable").checked = item.indispensable;

        document.getElementById("editar-categoria_ids").value = item.categorias.map(c => c.id).join(',');
        document.getElementById("editar-ubicacion_ids").value = item.ubicaciones.map(u => u.id).join(',');
        document.getElementById("editar-interaccion_ids").value = item.interacciones.map(i => i.id).join(',');
    });
});

// Editar item
document.getElementById("editar-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const itemId = document.getElementById("item_id").value;
    const formData = new FormData(form);

    ["categoria_ids","ubicacion_ids","interaccion_ids"].forEach(field => {
        const value = formData.get(field) || "";
        formData.delete(field);
        value.split(",").map(x => x.trim()).filter(x => x!=="").forEach(v => formData.append(field,v));
    });

    const response = await fetch(`/items/${itemId}`, { method:"PUT", body: formData });
    if(response.ok){
        alert("Item actualizado exitosamente.");
        ocultarFormEditar();
        location.reload();
    } else {
        const error = await response.json();
        alert("Error al actualizar: " + JSON.stringify(error.detail));
    }
});

// Eliminar item
async function eliminarItem(id) {
    if(!confirm("¿Seguro que deseas eliminar este ítem?")) return;

    const response = await fetch(`/items/${id}`, { method:"DELETE" });
    if(response.ok){
        alert("Item eliminado exitosamente.");
        window.location.href="/items";
    } else {
        const error = await response.json();
        alert("Error al eliminar el item: " + (error.detail || "Desconocido"));
    }
}
</script>
{% endblock %}