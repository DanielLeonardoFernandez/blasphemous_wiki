{% include 'header.html' %}

<h1>Detalles del Item</h1>

<a href="/items" class="btn btn-secondary mb-3">Volver a la lista</a>

<div class="card mb-4" style="max-width: 600px;">
    {% if item.imagen_url %}
        <img src="{{ item.imagen_url }}" class="card-img-top" alt="{{ item.nombre }}">
    {% else %}
        <img src="https://via.placeholder.com/600x300?text=Sin+imagen" class="card-img-top" alt="Sin imagen">
    {% endif %}

    <div class="card-body">
        <h5 class="card-title">{{ item.nombre }}</h5>
        <p class="card-text">{{ item.descripcion or "Sin descripción" }}</p>
        <p><strong>Costo:</strong> {{ item.costo or "No especificado" }}</p>
        <p><strong>Indispensable:</strong> {{ "Sí" if item.indispensable else "No" }}</p>
        <p><strong>Categorías:</strong> {% for c in item.categorias %}{{ c.id }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
        <p><strong>Ubicaciones:</strong> {% for u in item.ubicaciones %}{{ u.id }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
        <p><strong>Interacciones:</strong> {% for i in item.interacciones %}{{ i.id }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
        <p><strong>ID:</strong> {{ item.id }}</p>

        <div class="d-flex justify-content-between">
            <!-- Editar con fetch -->
            <button class="btn btn-primary btn-sm"
                onclick='mostrarFormEditar(
                    {{ item.id }},
                    "{{ item.nombre|escape }}",
                    "{{ item.descripcion|escape }}",
                    "{{ item.costo or "" }}",
                    {{ "true" if item.indispensable else "false" }},
                    "{{ item.categorias|map(attribute="id")|join(",") }}",
                    "{{ item.ubicaciones|map(attribute="id")|join(",") }}",
                    "{{ item.interacciones|map(attribute="id")|join(",") }}"
                )'>
                Editar
            </button>

            <!-- Eliminar REAL con fetch DELETE -->
            <button class="btn btn-danger btn-sm" onclick="eliminarItem({{ item.id }})">
                Eliminar
            </button>
        </div>
    </div>
</div>

<!-- FORMULARIO EDITAR (oculto inicialmente) -->
<div id="form-editar" class="card p-3 mb-4" style="display:none; max-width:600px;">
    <h4>Editar Item</h4>
    <form id="editar-form" enctype="multipart/form-data">
        <input type="hidden" name="item_id" id="item_id">

        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" id="editar-nombre" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea name="descripcion" id="editar-descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo</label>
            <input type="number" name="costo" id="editar-costo" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Indispensable</label>
            <input type="checkbox" name="indispensable" id="editar-indispensable">
        </div>

        <div class="mb-3">
            <label class="form-label">Categoría (IDs separados por coma)</label>
            <input type="text" name="categoria_ids" id="editar-categoria_ids" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen nueva (opcional)</label>
            <input type="file" name="imagen" id="editar-imagen" class="form-control">
            <p class="text-muted">Si no subes nada, la imagen se mantiene.</p>
        </div>

        <div class="mb-3">
            <label class="form-label">Ubicaciones (IDs separados por coma)</label>
            <input type="text" name="ubicaciones" id="editar-ubicaciones" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Interacciones (IDs separados por coma)</label>
            <input type="text" name="interacciones" id="editar-interacciones" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Guardar cambios</button>
        <button type="button" class="btn btn-secondary" onclick="ocultarFormEditar()">Cancelar</button>
    </form>
</div>

<script>
// Mostrar / ocultar formulario editar
function mostrarFormEditar(id, nombre, descripcion, costo, indispensable, categoria_id, ubicaciones, interacciones) {
    document.getElementById("form-editar").style.display = "block";
    document.getElementById("item_id").value = id;
    document.getElementById("editar-nombre").value = nombre;
    document.getElementById("editar-descripcion").value = descripcion;
    document.getElementById("editar-costo").value = costo;
    document.getElementById("editar-indispensable").checked = indispensable === true || indispensable === "true";
    document.getElementById("editar-categoria_ids").value = categoria_ids;
    document.getElementById("editar-ubicaciones").value = ubicaciones;
    document.getElementById("editar-interacciones").value = interacciones;
}
function ocultarFormEditar() {
    document.getElementById("form-editar").style.display = "none";
    document.getElementById("editar-form").reset();
}

// Enviar PUT /items/{id} con fetch
document.getElementById("editar-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const id = document.getElementById("item_id").value;
    const formData = new FormData(form);

    const response = await fetch(`/items/${id}`, {
        method: "PUT",
        body: formData
    });

    if(response.ok){
        alert("Item actualizado exitosamente.");
        form.reset();
        ocultarFormEditar();
        location.reload(); // recarga la página de detalles
    } else {
        const error = await response.json();
        alert("Error al actualizar el item: " + (error.detail || "Desconocido"));
    }
});

// Eliminar item
async function eliminarItem(id) {
    const confirmar = confirm("¿Seguro que deseas eliminar este item?");
    if (!confirmar) return;

    const response = await fetch(`/items/${id}`, { method: "DELETE" });

    if(response.ok) {
        alert("Item eliminado exitosamente.");
        window.location.href = "/items"; // vuelve a la lista
    } else {
        const error = await response.json();
        alert("Error al eliminar el item: " + (error.detail || "Desconocido"));
    }
}
</script>

{% include 'footer.html' %}
